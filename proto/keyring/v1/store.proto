syntax = "proto3";

package keyring.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/argus/ringforge/gen/keyring/v1;keyringv1";

// Blob is a content-addressed binary object.
message Blob {
  // BLAKE3 hash of the data (32 bytes).
  bytes hash = 1;

  // Raw binary content.
  bytes data = 2;

  // Size of the data in bytes.
  uint64 size = 3;
}

// Document is a mutable, versioned data record.
message Document {
  // Unique identifier for the document.
  string id = 1;

  // Serialised document content.
  bytes data = 2;

  // BLAKE3 hash of the current CRDT / merge state.
  bytes state_hash = 3;

  // When the document was first created.
  google.protobuf.Timestamp created_at = 4;

  // When the document was last modified.
  google.protobuf.Timestamp updated_at = 5;
}

// ---------------------------------------------------------------------------
// Blob RPCs
// ---------------------------------------------------------------------------

message PutBlobRequest {
  Blob blob = 1;
}

message PutBlobResponse {
  // BLAKE3 hash confirming storage.
  bytes hash = 1;
}

message GetBlobRequest {
  // BLAKE3 hash of the requested blob.
  bytes hash = 1;
}

message GetBlobResponse {
  Blob blob = 1;
}

// ---------------------------------------------------------------------------
// Document RPCs
// ---------------------------------------------------------------------------

message PutDocumentRequest {
  Document document = 1;
}

message PutDocumentResponse {
  // The document id (may be server-assigned on first put).
  string id = 1;

  // State hash after the write.
  bytes state_hash = 2;
}

message GetDocumentRequest {
  string id = 1;
}

message GetDocumentResponse {
  Document document = 1;
}

message ListDocumentsRequest {
  // Maximum number of documents to return. 0 = server default.
  uint32 page_size = 1;

  // Pagination token from a previous ListDocumentsResponse.
  string page_token = 2;
}

message ListDocumentsResponse {
  repeated Document documents = 1;

  // Token for the next page; empty when there are no more results.
  string next_page_token = 2;
}

// ---------------------------------------------------------------------------
// Services
// ---------------------------------------------------------------------------

// StoreService exposes blob and document storage over the mesh.
service StoreService {
  rpc PutBlob(PutBlobRequest) returns (PutBlobResponse);
  rpc GetBlob(GetBlobRequest) returns (GetBlobResponse);

  rpc PutDocument(PutDocumentRequest) returns (PutDocumentResponse);
  rpc GetDocument(GetDocumentRequest) returns (GetDocumentResponse);
  rpc ListDocuments(ListDocumentsRequest) returns (ListDocumentsResponse);
}
